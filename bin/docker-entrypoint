#!/bin/bash
set -e

echo "ğŸš€ Starting entrypoint..."
echo "ğŸŒ RAILS_ENV=${RAILS_ENV}"

# Enable jemalloc
if [ -z "${LD_PRELOAD+x}" ]; then
  LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
  export LD_PRELOAD
fi

# Jalankan migrate hanya jika menjalankan rails server
if [[ "$1" == "./bin/rails" && "$2" == "server" ]]; then
  echo "ğŸ› ï¸ Running db:prepare..."
  bundle exec rails db:prepare

  echo "ğŸ› ï¸ Running db:migrate..."
  bundle exec rails db:migrate
fi

echo "âœ… Entrypoint done, exec $@"
exec "$@"